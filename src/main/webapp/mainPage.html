<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main Page</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
</head>

<body onload="loadData()">
    <iframe name="dummyFrame" id="dummyFrame" style="display: none;"></iframe>
    <div id="nameWrapper">
    
    
    </div>
    <form action="/new-post" method="post" target="dummyFrame" onsubmit="setTimeout(function(){window.location.reload();},10);">
        Create New Post!
        <input name = "content">
        <input name = "userId" style="display:none" id="owner_id">
        <input type="submit" value="Submit" className="submitBtn">
    </form>
    <hr>
    <p id="unrepliedstyle">Unreplied Post:</p>
    <button onclick="myFunction()">Expand/Collapse</button>
    <div id="unRepliedWrapper">

    </div>
    <hr>
    <p id="repliedstyle">Replied Post:</p>
    <button onclick="myReplyFunction()">Expand/Collapse</button>
    <div id="repliedWrapper">

    </div>

<script>

    async function getUnrepliedPost(){
        var token;
        let matchToken = document.cookie.match(new RegExp('(^| )' + "token" + '=([^;]+)'));
        if(matchToken!=null){
            token = atob(matchToken[2]);
        }
        var url_string = window.location.href; 
        var url = new URL(url_string);
        var id = atob(url.searchParams.get("id"));
        console.log(id);

        var unRepliedResults = await fetch(("/display-posts-unreplied"), {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Basic "+token,
                "Url-Id": "Basic "+id,
            },
        });
        var unRepliedResultsJson = await unRepliedResults.json();
        console.log(unRepliedResultsJson);
        var unRepliedWrapper = document.getElementById("unRepliedWrapper");
        unRepliedWrapper.innerHTML = "";
        for (var i = 0; i < unRepliedResultsJson.length; i++) {
            var unRepliedDiv = document.createElement("div");
            unRepliedDiv.className = "unRepliedDiv";
            var message = document.createElement("ul");
            message.innerHTML = unRepliedResultsJson[i][0];
            message.className = "message";
            
            //create response form
            var responseForm = document.createElement("form");
            responseForm.action = "/reply-post";
            responseForm.method = "post";
            responseForm.target = "dummyFrame";

            var responseInput = document.createElement("input");
            responseInput.name = "content";
            responseInput.type = "text";
            responseInput.placeholder = "reply";

            
            var responseOwnerId = document.createElement("input");
            responseOwnerId.name = "ownerId";
            responseOwnerId.type = "hidden";
            responseOwnerId.value = unRepliedResultsJson[i][1];

            var responsePostId = document.createElement("input");
            responsePostId.name = "postId";
            responsePostId.type = "hidden";
            responsePostId.value = unRepliedResultsJson[i][2];

            var originalContent = document.createElement("input");
            originalContent.name = "originalContent";
            originalContent.type = "hidden";
            originalContent.value = unRepliedResultsJson[i][0];

            var responseSubmit = document.createElement("input");
            responseSubmit.type = "submit";
            responseSubmit.value = "Submit";
            responseSubmit.className = "submitBtn";
            responseSubmit.onclick = function(){setTimeout(()=>{window.location.reload();}, 10)};



            responseForm.appendChild(message);
            responseForm.appendChild(responseInput);
            responseForm.appendChild(responseOwnerId);
            responseForm.appendChild(responsePostId);
            responseForm.appendChild(originalContent);
            responseForm.appendChild(responseSubmit);
            unRepliedDiv.appendChild(responseForm);
            unRepliedWrapper.appendChild(unRepliedDiv);
        }
    }

    async function getRepliedPost(owner_id){
        var id = atob(owner_id);
        var repliedResults = await fetch("/display-posts-replied", {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                    "Owner-Id": "Basic "+ id,
                },
        });
        var repliedResultsJson = await repliedResults.json();
        console.log(repliedResultsJson);
        var repliedWrapper = document.getElementById("repliedWrapper");
        repliedWrapper.innerHTML = "";
        for (var i = 0; i < repliedResultsJson.length; i++) {
            var repliedDiv = document.createElement("div");
            repliedDiv.className = "repliedDiv";
            var message = document.createElement("ul");
            message.innerHTML = "\""+repliedResultsJson[i][0]+"\"";
            message.className = "message";
            
            var reply = document.createElement("ul");
            reply.innerHTML = "Reply: "+repliedResultsJson[i][1];
            reply.className = "reply";

            repliedDiv.appendChild(message);
            repliedDiv.appendChild(reply);
            repliedWrapper.appendChild(repliedDiv);
        }
    }

    async function loadData()
    {

        //I deleted cookie login here, and it should be replaced by something that could get Google ID. 
        //TODO: provide a valid user id from Google's API
        var user_id = "IT SHOULD BE REPLACED BY GOOGLE's ID "
        var url = window.location.href;
        var owner_id = url.substring(url.indexOf("?") + 1);
        owner_id=owner_id.split("=")[1];
        document.getElementById("owner_id").value = owner_id;
        console.log (user_id);
        console.log (owner_id);

        //TODO: if the user has a valid id, then send to the server (prevent bad behavior)
        if (1) {
            getUnrepliedPost();
        }

        //if the url has a valid id, then send to the server (prevent bad behavior)
        if(owner_id){
            getRepliedPost(owner_id);
        }
	

    }

    function myFunction() {
        var x = document.getElementById("unRepliedWrapper");
        if (x.style.display === "none") {
            x.style.display = "block";
        } else {
            x.style.display = "none";
        }
    } 

    function myReplyFunction() {
        var x = document.getElementById("repliedWrapper");
        if (x.style.display === "none") {
            x.style.display = "block";
        } else {
            x.style.display = "none";
        }
    }
    
</script>
</body>
</html>